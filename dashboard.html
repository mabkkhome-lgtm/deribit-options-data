<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Levels - Evolution Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e222d;
            border-bottom: 1px solid #363a45;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .logo {
            font-weight: 600;
            font-size: 15px;
        }

        .price-box {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #787b86;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #26a69a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #1e222d;
            padding: 6px 12px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #363a45;
        }

        .toolbar button {
            padding: 5px 12px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #d1d4dc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .toolbar button:hover {
            background: #363a45;
        }

        .toolbar button.active {
            background: #2962ff;
            border-color: #2962ff;
        }

        #chart {
            flex: 1;
        }

        .sidebar {
            width: 300px;
            background: #1e222d;
            border-left: 1px solid #363a45;
            overflow-y: auto;
            font-size: 12px;
        }

        .panel {
            border-bottom: 1px solid #363a45;
            padding: 12px;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #2a2e39;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .level-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot.r {
            background: #00ff00;
        }

        .dot.s {
            background: #ff0000;
        }

        .dot.c {
            background: #2962ff;
        }

        .level-value {
            font-weight: 600;
            font-family: 'Monaco', monospace;
            font-size: 11px;
        }

        .level-value.r {
            color: #00ff00;
        }

        .level-value.s {
            color: #ff0000;
        }

        .level-value.c {
            color: #2962ff;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #2a2e39;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #787b86;
        }

        .stats-value {
            font-weight: 500;
        }

        .stats-value.green {
            color: #4caf50;
        }

        .stats-value.red {
            color: #f44336;
        }

        .stats-value.yellow {
            color: #ffeb3b;
        }

        .stats-value.cyan {
            color: #00bcd4;
        }

        .history-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 10px;
        }

        .history-time {
            color: #787b86;
            min-width: 50px;
        }

        .history-r {
            color: #00ff00;
        }

        .history-s {
            color: #ff0000;
        }

        .btn-refresh {
            background: #2962ff !important;
            border-color: #2962ff !important;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">ğŸ“Š Options Levels Evolution</div>
        <div class="price-box">
            <span class="price" id="price">$---,---</span>
        </div>
        <div class="status">
            <span class="status-dot"></span>
            <span id="status">Connecting...</span>
        </div>
    </header>

    <div class="main">
        <div class="chart-area">
            <div class="toolbar">
                <button data-tf="1">1m</button>
                <button data-tf="5">5m</button>
                <button data-tf="15" class="active">15m</button>
                <button data-tf="60">1H</button>
                <button data-tf="240">4H</button>
                <button data-tf="D">1D</button>
                <button class="btn-refresh" id="btn-refresh">ğŸ”„ Calculate Now</button>
            </div>
            <div id="chart"></div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">ğŸ“Š Current Levels (Latest)</div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot r"></div> Resistance
                    </div>
                    <span class="level-value r" id="r-val">---</span>
                </div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot c"></div> Price
                    </div>
                    <span class="level-value c" id="c-val">$---</span>
                </div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot s"></div> Support
                    </div>
                    <span class="level-value s" id="s-val">---</span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“ˆ Stats</div>
                <div class="stats-row"><span class="stats-label">Range</span><span class="stats-value yellow"
                        id="stat-range">$---</span></div>
                <div class="stats-row"><span class="stats-label">Longs</span><span class="stats-value green"
                        id="stat-longs">--</span></div>
                <div class="stats-row"><span class="stats-label">Shorts</span><span class="stats-value red"
                        id="stat-shorts">--</span></div>
                <div class="stats-row"><span class="stats-label">Next Calc</span><span class="stats-value cyan"
                        id="stat-next">--:--</span></div>
                <div class="stats-row"><span class="stats-label">Data Points</span><span class="stats-value"
                        id="stat-points">0</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“œ Level Evolution (All Calculations)</div>
                <div class="history-list" id="history-list">
                    <div class="history-item"><span class="history-time">Waiting...</span></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIG
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const THALES_API = 'https://oss.thales-mfi.com/api/MarketScreener/FetchOptions';
        const UPDATE_INTERVAL_MS = 60000; // 1 minute
        const CORS_PROXY = 'https://corsproxy.io/?';
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE - EVOLUTION DATA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let chart, candleSeries, rSeries, sSeries;
        let currentPrice = 0;
        let timeframe = '15';
        let ws = null;
        let nextUpdateTime = null;
        
        // EVOLUTION DATA: Each calculation adds a point
        // Format: { time: unix_timestamp, r: resistance, s: support }
        let evolutionData = [];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THALES CALCULATION (from Python)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function getTomorrowExpiryCode() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setUTCHours(0, 0, 0, 0);
            const epoch = new Date(0);
            const daysSinceEpoch = Math.floor((tomorrow - epoch) / (1000 * 60 * 60 * 24));
            return daysSinceEpoch;
        }
        
        function parseOptionsCSV(csvData, targetExpiryCode) {
            const longs = [], shorts = [];
            for (const line of csvData.trim().split('\n')) {
                if (!line.trim()) continue;
                const parts = line.split(',');
                if (parts.length < 7) continue;
                try {
                    const expiryCode = parseInt(parts[1]);
                    if (expiryCode !== targetExpiryCode) continue;
                    const pos = {
                        type: parseInt(parts[0]) === 0 ? 'call' : 'put',
                        strike: parseFloat(parts[2]),
                        size: parseFloat(parts[5]),
                        premium_usd: parseFloat(parts[6])
                    };
                    if (parseInt(parts[4]) === 0) longs.push(pos);
                    else shorts.push(pos);
                } catch (e) { continue; }
            }
            return { longs, shorts };
        }
        
        function calculatePnL(positions, price, isBuyer) {
            let total = 0;
            for (const p of positions) {
                const intrinsic = p.type === 'call' 
                    ? Math.max(price - p.strike, 0) 
                    : Math.max(p.strike - price, 0);
                total += (isBuyer ? intrinsic - p.premium_usd : p.premium_usd - intrinsic) * p.size;
            }
            return total;
        }
        
        function findConvergence(longs, shorts) {
            const strikes = [...longs, ...shorts].map(p => p.strike);
            if (strikes.length === 0) return { r: 95000, s: 85000 };
            
            const minP = Math.floor(Math.min(...strikes) * 0.9);
            const maxP = Math.ceil(Math.max(...strikes) * 1.1);
            const intersections = [];
            let prevDiff = null;
            
            for (let price = minP; price < maxP; price += 10) {
                const diff = calculatePnL(longs, price, true) - calculatePnL(shorts, price, false);
                if (prevDiff !== null && prevDiff * diff < 0) {
                    intersections.push(price);
                }
                prevDiff = diff;
            }
            
            if (intersections.length >= 2) return { s: intersections[0], r: intersections[intersections.length - 1] };
            if (intersections.length === 1) return { s: intersections[0], r: intersections[0] };
            const avg = strikes.reduce((a, b) => a + b, 0) / strikes.length;
            return { s: Math.round(avg * 0.95), r: Math.round(avg * 1.05) };
        }
        
        async function fetchAndCalculate() {
            document.getElementById('status').textContent = 'Calculating...';
            
            try {
                const now = new Date();
                const startOfDay = new Date(now); startOfDay.setUTCHours(0, 0, 0, 0);
                
                const url = `${CORS_PROXY}${THALES_API}?source=1&fromDate=${startOfDay.getTime()}&toDate=${now.getTime()}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Fetch failed');
                
                const csv = await res.text();
                const expiryCode = getTomorrowExpiryCode();
                const { longs, shorts } = parseOptionsCSV(csv, expiryCode);
                
                document.getElementById('stat-longs').textContent = longs.length;
                document.getElementById('stat-shorts').textContent = shorts.length;
                
                if (longs.length === 0 || shorts.length === 0) {
                    console.warn('No positions found');
                    return;
                }
                
                const { r, s } = findConvergence(longs, shorts);
                const timestamp = Math.floor(now.getTime() / 1000);
                
                // ADD NEW POINT TO EVOLUTION DATA
                evolutionData.push({ time: timestamp, r, s });
                
                console.log(`âœ… ${now.toLocaleTimeString()} - R: ${r}, S: ${s}`);
                
                // Update chart lines
                updateEvolutionLines();
                updateUI(r, s);
                updateHistory();
                
                document.getElementById('stat-points').textContent = evolutionData.length;
                document.getElementById('status').textContent = 'Live';
                
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('status').textContent = 'Error';
            }
            
            scheduleNext();
        }
        
        function scheduleNext() {
            nextUpdateTime = Date.now() + UPDATE_INTERVAL_MS;
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHART
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function initChart() {
            const container = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                rightPriceScale: { borderColor: '#363a45' },
                timeScale: { borderColor: '#363a45', timeVisible: true },
                crosshair: { mode: 1 },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderUpColor: '#26a69a', borderDownColor: '#ef5350',
                wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });
            
            // EVOLUTION LINES - will show the R/S path over time
            rSeries = chart.addLineSeries({ 
                color: '#00ff00', 
                lineWidth: 3, 
                title: 'R',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            sSeries = chart.addLineSeries({ 
                color: '#ff0000', 
                lineWidth: 3, 
                title: 'S',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            new ResizeObserver(() => {
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            }).observe(container);
        }
        
        function updateEvolutionLines() {
            if (evolutionData.length === 0) return;
            
            // Convert evolution data to line series format
            const rData = evolutionData.map(d => ({ time: d.time, value: d.r }));
            const sData = evolutionData.map(d => ({ time: d.time, value: d.s }));
            
            rSeries.setData(rData);
            sSeries.setData(sData);
        }
        
        async function fetchCandles() {
            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=500`);
            const data = await res.json();
            
            const candles = data.map(d => ({
                time: d[0] / 1000,
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4]),
            }));
            
            candleSeries.setData(candles);
            chart.timeScale().fitContent();
        }
        
        function connectWS() {
            if (ws) ws.close();
            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${interval}`);
            
            ws.onmessage = (e) => {
                const { k } = JSON.parse(e.data);
                currentPrice = parseFloat(k.c);
                
                candleSeries.update({
                    time: k.t / 1000,
                    open: parseFloat(k.o),
                    high: parseFloat(k.h),
                    low: parseFloat(k.l),
                    close: parseFloat(k.c),
                });
                
                document.getElementById('price').textContent = '$' + currentPrice.toLocaleString('en-US', { maximumFractionDigits: 0 });
                document.getElementById('c-val').textContent = '$' + currentPrice.toLocaleString();
            };
            
            ws.onopen = () => {
                if (evolutionData.length > 0) document.getElementById('status').textContent = 'Live';
            };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function updateUI(r, s) {
            const fmt = n => '$' + n.toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('r-val').textContent = fmt(r);
            document.getElementById('s-val').textContent = fmt(s);
            document.getElementById('stat-range').textContent = fmt(r - s);
        }
        
        function updateHistory() {
            const container = document.getElementById('history-list');
            if (evolutionData.length === 0) {
                container.innerHTML = '<div class="history-item"><span class="history-time">No data</span></div>';
                return;
            }
            
            // Show most recent first
            const reversed = [...evolutionData].reverse();
            container.innerHTML = reversed.map(d => {
                const time = new Date(d.time * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                return `<div class="history-item">
                    <span class="history-time">${time}</span>
                    <span class="history-r">R: $${(d.r/1000).toFixed(1)}K</span>
                    <span class="history-s">S: $${(d.s/1000).toFixed(1)}K</span>
                </div>`;
            }).join('');
        }
        
        function updateCountdown() {
            if (nextUpdateTime) {
                const secs = Math.max(0, Math.floor((nextUpdateTime - Date.now()) / 1000));
                const mins = Math.floor(secs / 60);
                const s = secs % 60;
                document.getElementById('stat-next').textContent = `${mins}:${s.toString().padStart(2, '0')}`;
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                timeframe = btn.dataset.tf;
                fetchCandles().then(() => {
                    updateEvolutionLines();
                    connectWS();
                });
            });
        });
        
        document.getElementById('btn-refresh').addEventListener('click', fetchAndCalculate);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        initChart();
        fetchCandles().then(() => {
            connectWS();
            fetchAndCalculate();
        });
        
        setInterval(fetchAndCalculate, UPDATE_INTERVAL_MS);
        setInterval(updateCountdown, 1000);
    </script>
</body>

</html>