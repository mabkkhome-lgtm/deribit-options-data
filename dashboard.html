<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Levels Tracker - Real-Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e222d;
            border-bottom: 1px solid #363a45;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .logo {
            font-weight: 600;
            font-size: 15px;
        }

        .price-box {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
        }

        .change {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .change.up {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }

        .change.down {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #787b86;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #26a69a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #1e222d;
            padding: 6px 12px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #363a45;
        }

        .toolbar button {
            padding: 5px 12px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #d1d4dc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .toolbar button:hover {
            background: #363a45;
        }

        .toolbar button.active {
            background: #2962ff;
            border-color: #2962ff;
        }

        #chart {
            flex: 1;
        }

        .sidebar {
            width: 300px;
            background: #1e222d;
            border-left: 1px solid #363a45;
            overflow-y: auto;
            font-size: 12px;
        }

        .panel {
            border-bottom: 1px solid #363a45;
            padding: 12px;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #2a2e39;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .level-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot.r {
            background: #00ff00;
        }

        .dot.s {
            background: #ff0000;
        }

        .dot.c {
            background: #2962ff;
        }

        .level-value {
            font-weight: 600;
            font-family: 'Monaco', monospace;
            font-size: 11px;
        }

        .level-value.r {
            color: #00ff00;
        }

        .level-value.s {
            color: #ff0000;
        }

        .level-value.c {
            color: #2962ff;
        }

        .position-bar {
            height: 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin: 10px 0 6px;
            position: relative;
        }

        .position-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffd600, #00ff00);
            border-radius: 3px;
        }

        .position-marker {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 10px;
            background: #2962ff;
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .position-text {
            text-align: center;
            font-size: 11px;
            color: #787b86;
        }

        .position-pct {
            color: #d1d4dc;
            font-weight: 600;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #2a2e39;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #787b86;
        }

        .stats-value {
            font-weight: 500;
        }

        .stats-value.green {
            color: #4caf50;
        }

        .stats-value.red {
            color: #f44336;
        }

        .stats-value.yellow {
            color: #ffeb3b;
        }

        .stats-value.cyan {
            color: #00bcd4;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 10px;
        }

        .history-time {
            color: #787b86;
        }

        .history-r {
            color: #00ff00;
        }

        .history-s {
            color: #ff0000;
        }

        .btn-refresh {
            background: #2962ff !important;
            border-color: #2962ff !important;
            margin-left: auto;
        }

        .loading {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">ğŸ“Š Options Levels (Real-Time)</div>
        <div class="price-box">
            <span class="price" id="price">$---,---</span>
            <span class="change up" id="change">+0.00%</span>
        </div>
        <div class="status">
            <span class="status-dot"></span>
            <span id="status">Connecting...</span>
        </div>
    </header>

    <div class="main">
        <div class="chart-area">
            <div class="toolbar">
                <button data-tf="1">1m</button>
                <button data-tf="5">5m</button>
                <button data-tf="15" class="active">15m</button>
                <button data-tf="60">1H</button>
                <button data-tf="240">4H</button>
                <button data-tf="D">1D</button>
                <button class="btn-refresh" id="btn-refresh">ğŸ”„ Refresh Levels</button>
            </div>
            <div id="chart"></div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">ğŸ“Š Tomorrow's Prediction (Live)</div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot r"></div> Resistance
                    </div>
                    <span class="level-value r" id="r-val">Calculating...</span>
                </div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot c"></div> Current Price
                    </div>
                    <span class="level-value c" id="c-val">$---</span>
                </div>
                <div class="level">
                    <div class="level-label">
                        <div class="dot s"></div> Support
                    </div>
                    <span class="level-value s" id="s-val">Calculating...</span>
                </div>
                <div class="position-bar">
                    <div class="position-fill"></div>
                    <div class="position-marker" id="marker" style="left:50%"></div>
                </div>
                <div class="position-text"><span class="position-pct" id="pct">--</span>% in range</div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“ˆ Live Stats</div>
                <div class="stats-row"><span class="stats-label">Range</span><span class="stats-value yellow"
                        id="stat-range">$---</span></div>
                <div class="stats-row"><span class="stats-label">Dist to R</span><span class="stats-value green"
                        id="stat-dist-r">--%</span></div>
                <div class="stats-row"><span class="stats-label">Dist to S</span><span class="stats-value red"
                        id="stat-dist-s">--%</span></div>
                <div class="stats-row"><span class="stats-label">Position</span><span class="stats-value yellow"
                        id="stat-pos">--</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ”„ Thales OSS Data</div>
                <div class="stats-row"><span class="stats-label">Expiry</span><span class="stats-value cyan"
                        id="stat-expiry">Tomorrow</span></div>
                <div class="stats-row"><span class="stats-label">Long Positions</span><span class="stats-value"
                        id="stat-longs">--</span></div>
                <div class="stats-row"><span class="stats-label">Short Positions</span><span class="stats-value"
                        id="stat-shorts">--</span></div>
                <div class="stats-row"><span class="stats-label">Last Calc</span><span class="stats-value"
                        id="stat-time">--:--</span></div>
                <div class="stats-row"><span class="stats-label">Next Update</span><span class="stats-value cyan"
                        id="stat-next">--:--</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">ğŸ“œ Level History (Today)</div>
                <div class="history-list" id="history-list">
                    <div class="history-item"><span class="history-time">Waiting for data...</span></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const THALES_API = 'https://oss.thales-mfi.com/api/MarketScreener/FetchOptions';
        const UPDATE_INTERVAL_MS = 60000; // 1 minute
        const CORS_PROXY = 'https://corsproxy.io/?'; // Free CORS proxy

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let chart, candleSeries, rSeries, sSeries;
        let currentLevels = { r: 0, s: 0 };
        let currentPrice = 0;
        let timeframe = '15';
        let ws = null;
        let levelHistory = [];
        let nextUpdateTime = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THALES OSS CALCULATION (Ported from Python)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function getTomorrowExpiryCode() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setUTCHours(0, 0, 0, 0);
            const epoch = new Date(0);
            const daysSinceEpoch = Math.floor((tomorrow - epoch) / (1000 * 60 * 60 * 24));
            const dateStr = `${tomorrow.getDate().toString().padStart(2, '0')}/${(tomorrow.getMonth() + 1).toString().padStart(2, '0')}/${tomorrow.getFullYear()}`;
            return { code: daysSinceEpoch, dateStr };
        }

        function parseOptionsCSV(csvData, targetExpiryCode) {
            const longs = [];
            const shorts = [];

            const lines = csvData.trim().split('\n');
            for (const line of lines) {
                if (!line.trim()) continue;
                const parts = line.split(',');
                if (parts.length < 7) continue;

                try {
                    const optionType = parseInt(parts[0]);
                    const expiryCode = parseInt(parts[1]);
                    const strike = parseFloat(parts[2]);
                    const side = parseInt(parts[4]);
                    const size = parseFloat(parts[5]);
                    const entryPriceUSD = parseFloat(parts[6]);

                    if (expiryCode !== targetExpiryCode) continue;

                    const position = {
                        type: optionType === 0 ? 'call' : 'put',
                        strike,
                        size,
                        premium_usd: entryPriceUSD
                    };

                    if (side === 0) {
                        longs.push(position);
                    } else {
                        shorts.push(position);
                    }
                } catch (e) {
                    continue;
                }
            }

            return { longs, shorts };
        }

        function calculatePnLAtExpiry(positions, underlyingPrice, isBuyer) {
            let totalPnL = 0;

            for (const pos of positions) {
                const strike = pos.strike;
                const size = pos.size;
                const premium = pos.premium_usd;

                let intrinsic;
                if (pos.type === 'call') {
                    intrinsic = Math.max(underlyingPrice - strike, 0);
                } else {
                    intrinsic = Math.max(strike - underlyingPrice, 0);
                }

                let pnl;
                if (isBuyer) {
                    pnl = (intrinsic - premium) * size;
                } else {
                    pnl = (premium - intrinsic) * size;
                }

                totalPnL += pnl;
            }

            return totalPnL;
        }

        function findConvergencePoints(longs, shorts) {
            const allStrikes = [...longs, ...shorts].map(p => p.strike);
            if (allStrikes.length === 0) return { support: 85000, resistance: 100000 };

            const minStrike = Math.min(...allStrikes);
            const maxStrike = Math.max(...allStrikes);

            const priceMin = Math.floor(minStrike * 0.90);
            const priceMax = Math.ceil(maxStrike * 1.10);
            const step = 10;

            const intersections = [];
            let prevLongPnL = null;
            let prevShortPnL = null;

            for (let price = priceMin; price < priceMax; price += step) {
                const longPnL = calculatePnLAtExpiry(longs, price, true);
                const shortPnL = calculatePnLAtExpiry(shorts, price, false);

                if (prevLongPnL !== null) {
                    const prevDiff = prevLongPnL - prevShortPnL;
                    const currDiff = longPnL - shortPnL;

                    if (prevDiff * currDiff < 0) {
                        const t = Math.abs(prevDiff) / (Math.abs(prevDiff) + Math.abs(currDiff));
                        const crossingPrice = (price - step) + t * step;
                        intersections.push(Math.round(crossingPrice));
                    }
                }

                prevLongPnL = longPnL;
                prevShortPnL = shortPnL;
            }

            console.log(`Found ${intersections.length} intersection points:`, intersections);

            if (intersections.length >= 2) {
                return { support: intersections[0], resistance: intersections[intersections.length - 1] };
            } else if (intersections.length === 1) {
                return { support: intersections[0], resistance: intersections[0] };
            } else {
                const meanStrike = allStrikes.reduce((a, b) => a + b, 0) / allStrikes.length;
                return { support: Math.round(meanStrike * 0.95), resistance: Math.round(meanStrike * 1.05) };
            }
        }

        async function fetchAndCalculateLevels() {
            const btn = document.getElementById('btn-refresh');
            btn.classList.add('loading');
            btn.disabled = true;
            document.getElementById('status').textContent = 'Calculating...';

            try {
                const now = new Date();
                const startOfDay = new Date(now);
                startOfDay.setUTCHours(0, 0, 0, 0);

                const fromTimestamp = startOfDay.getTime();
                const toTimestamp = now.getTime();

                const url = `${CORS_PROXY}${THALES_API}?source=1&fromDate=${fromTimestamp}&toDate=${toTimestamp}`;

                console.log('Fetching from Thales OSS...');
                const response = await fetch(url);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const csvData = await response.text();
                const totalLines = csvData.trim().split('\n').length;
                console.log(`Received ${totalLines} trade records`);

                const { code: expiryCode, dateStr: expiryDate } = getTomorrowExpiryCode();
                document.getElementById('stat-expiry').textContent = expiryDate;

                const { longs, shorts } = parseOptionsCSV(csvData, expiryCode);
                console.log(`Longs: ${longs.length}, Shorts: ${shorts.length}`);

                document.getElementById('stat-longs').textContent = longs.length;
                document.getElementById('stat-shorts').textContent = shorts.length;

                if (longs.length === 0 || shorts.length === 0) {
                    console.warn('Not enough data');
                    document.getElementById('status').textContent = 'No data';
                    return;
                }

                const { support, resistance } = findConvergencePoints(longs, shorts);

                // Track changes
                if (currentLevels.r > 0 && (resistance !== currentLevels.r || support !== currentLevels.s)) {
                    levelHistory.unshift({
                        time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                        r: resistance,
                        s: support
                    });
                    if (levelHistory.length > 50) levelHistory.pop();
                    updateHistory();
                }

                currentLevels = { r: resistance, s: support };

                // Update dynamic lines
                updateDynamicLines();
                updateUI();
                updateStats();

                document.getElementById('stat-time').textContent = now.toLocaleTimeString();
                document.getElementById('status').textContent = 'Live';

                console.log(`âœ… Resistance: ${resistance}, Support: ${support}`);

            } catch (e) {
                console.error('Error fetching levels:', e);
                document.getElementById('status').textContent = 'Error - retrying...';
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                scheduleNextUpdate();
            }
        }

        function scheduleNextUpdate() {
            nextUpdateTime = new Date(Date.now() + UPDATE_INTERVAL_MS);
            updateNextTime();
        }

        function updateNextTime() {
            if (nextUpdateTime) {
                const diff = Math.max(0, Math.floor((nextUpdateTime - Date.now()) / 1000));
                const mins = Math.floor(diff / 60);
                const secs = diff % 60;
                document.getElementById('stat-next').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHART
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function initChart() {
            const container = document.getElementById('chart');

            chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                rightPriceScale: { borderColor: '#363a45' },
                timeScale: { borderColor: '#363a45', timeVisible: true },
                crosshair: { mode: 1 },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderUpColor: '#26a69a', borderDownColor: '#ef5350',
                wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });

            rSeries = chart.addLineSeries({ color: '#00ff00', lineWidth: 2, title: 'R', priceLineVisible: true, lastValueVisible: true });
            sSeries = chart.addLineSeries({ color: '#ff0000', lineWidth: 2, title: 'S', priceLineVisible: true, lastValueVisible: true });

            new ResizeObserver(() => {
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            }).observe(container);
        }

        let chartData = [];

        async function fetchCandles() {
            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=500`);
            const data = await res.json();

            chartData = data.map(d => ({
                time: d[0] / 1000,
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4]),
            }));

            candleSeries.setData(chartData);
            chart.timeScale().fitContent();

            if (currentLevels.r > 0) updateDynamicLines();
        }

        function updateDynamicLines() {
            if (chartData.length === 0 || currentLevels.r === 0) return;

            // Create dynamic line data for the visible candles
            const rData = chartData.map(c => ({ time: c.time, value: currentLevels.r }));
            const sData = chartData.map(c => ({ time: c.time, value: currentLevels.s }));

            rSeries.setData(rData);
            sSeries.setData(sData);
        }

        function connectWS() {
            if (ws) ws.close();

            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${interval}`);

            ws.onmessage = (e) => {
                const { k } = JSON.parse(e.data);
                currentPrice = parseFloat(k.c);
                const candleTime = k.t / 1000;

                candleSeries.update({
                    time: candleTime,
                    open: parseFloat(k.o),
                    high: parseFloat(k.h),
                    low: parseFloat(k.l),
                    close: parseFloat(k.c),
                });

                if (currentLevels.r > 0) {
                    rSeries.update({ time: candleTime, value: currentLevels.r });
                    sSeries.update({ time: candleTime, value: currentLevels.s });
                }

                updateUI();
            };

            ws.onopen = () => {
                if (currentLevels.r > 0) document.getElementById('status').textContent = 'Live';
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI UPDATES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function updateUI() {
            const fmt = (n) => '$' + n.toLocaleString('en-US', { maximumFractionDigits: 0 });

            document.getElementById('price').textContent = fmt(currentPrice);
            document.getElementById('c-val').textContent = fmt(currentPrice);
            document.getElementById('r-val').textContent = fmt(currentLevels.r);
            document.getElementById('s-val').textContent = fmt(currentLevels.s);

            if (currentLevels.r > currentLevels.s && currentPrice > 0) {
                const range = currentLevels.r - currentLevels.s;
                const pct = ((currentPrice - currentLevels.s) / range) * 100;
                const clamped = Math.max(0, Math.min(100, pct));
                document.getElementById('marker').style.left = clamped + '%';
                document.getElementById('pct').textContent = pct.toFixed(1);
            }
        }

        function updateStats() {
            const r = currentLevels.r;
            const s = currentLevels.s;
            const range = r - s;

            document.getElementById('stat-range').textContent = '$' + range.toLocaleString();

            if (currentPrice > 0 && r > 0 && s > 0) {
                const distR = ((r - currentPrice) / currentPrice * 100).toFixed(2);
                const distS = ((currentPrice - s) / currentPrice * 100).toFixed(2);
                document.getElementById('stat-dist-r').textContent = distR + '%';
                document.getElementById('stat-dist-s').textContent = distS + '%';

                const pct = ((currentPrice - s) / range) * 100;
                let posText = 'âšª Mid';
                if (pct > 66) posText = 'ğŸ”´ Near R';
                else if (pct < 33) posText = 'ğŸŸ¢ Near S';
                document.getElementById('stat-pos').textContent = posText + ' ' + pct.toFixed(1) + '%';
            }
        }

        function updateHistory() {
            const container = document.getElementById('history-list');
            if (levelHistory.length === 0) {
                container.innerHTML = '<div class="history-item"><span class="history-time">No changes</span></div>';
                return;
            }

            container.innerHTML = levelHistory.map(h => `
                <div class="history-item">
                    <span class="history-time">${h.time}</span>
                    <span class="history-r">R: $${(h.r / 1000).toFixed(1)}K</span>
                    <span class="history-s">S: $${(h.s / 1000).toFixed(1)}K</span>
                </div>
            `).join('');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EVENT LISTENERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                timeframe = btn.dataset.tf;
                fetchCandles().then(connectWS);
            });
        });

        document.getElementById('btn-refresh').addEventListener('click', fetchAndCalculateLevels);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        initChart();
        fetchCandles().then(() => {
            connectWS();
            fetchAndCalculateLevels();
        });

        // Auto-update every minute
        setInterval(fetchAndCalculateLevels, UPDATE_INTERVAL_MS);
        setInterval(updateNextTime, 1000);
    </script>
</body>

</html>