<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Levels - Dynamic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e222d;
            border-bottom: 1px solid #363a45;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .logo {
            font-weight: 600;
            font-size: 15px;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #787b86;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #26a69a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #1e222d;
            padding: 6px 12px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #363a45;
        }

        .toolbar button {
            padding: 5px 12px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #d1d4dc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .toolbar button:hover {
            background: #363a45;
        }

        .toolbar button.active {
            background: #2962ff;
            border-color: #2962ff;
        }

        #chart {
            flex: 1;
        }

        .sidebar {
            width: 280px;
            background: #1e222d;
            border-left: 1px solid #363a45;
            overflow-y: auto;
            font-size: 12px;
        }

        .panel {
            border-bottom: 1px solid #363a45;
            padding: 12px;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            margin-bottom: 10px;
        }

        .level {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            background: #2a2e39;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .level-value {
            font-weight: 600;
            font-family: 'Monaco', monospace;
            font-size: 11px;
        }

        .level-value.r {
            color: #2196f3;
        }

        .level-value.s {
            color: #9c27b0;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #2a2e39;
            font-size: 11px;
        }

        .stats-label {
            color: #787b86;
        }

        .history-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .history-item {
            padding: 3px 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin-bottom: 2px;
            font-size: 10px;
            color: #d1d4dc;
        }

        .btn-calc {
            background: #2962ff !important;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">ðŸ“Š Options Levels Tracker</div>
        <div><span class="price" id="price">$---,---</span></div>
        <div class="status"><span class="status-dot"></span><span id="status">Loading...</span></div>
    </header>

    <div class="main">
        <div class="chart-area">
            <div class="toolbar">
                <button data-tf="1" class="active">1m</button>
                <button data-tf="5">5m</button>
                <button data-tf="15">15m</button>
                <button data-tf="60">1H</button>
                <button class="btn-calc" id="btn-calc">ðŸ”„ Calculate</button>
            </div>
            <div id="chart"></div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">ðŸ“Š Current Levels</div>
                <div class="level"><span>Resistance</span><span class="level-value r" id="r-val">---</span></div>
                <div class="level"><span>Support</span><span class="level-value s" id="s-val">---</span></div>
                <div class="level"><span>Range</span><span class="level-value" id="range-val">$---</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">ðŸ“ˆ Stats</div>
                <div class="stats-row"><span class="stats-label">Data Points</span><span id="stat-points">0</span></div>
                <div class="stats-row"><span class="stats-label">Longs</span><span id="stat-longs">--</span></div>
                <div class="stats-row"><span class="stats-label">Shorts</span><span id="stat-shorts">--</span></div>
                <div class="stats-row"><span class="stats-label">Next Calc</span><span id="stat-next">--:--</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">ðŸ“œ History</div>
                <div class="history-list" id="history">Waiting...</div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const API = 'https://oss.thales-mfi.com/api/MarketScreener/FetchOptions';
        const PROXY = 'https://corsproxy.io/?';
        const INTERVAL = 60000;

        let chart, candleSeries, rSeries, sSeries;
        let tf = '1';
        let ws = null;
        let nextUpdate = null;

        // Array of {time, r, s} - each calculation adds a point
        let points = [];
        let candles = [];

        function getTomorrowExpiry() {
            const t = new Date(); t.setDate(t.getDate() + 1); t.setUTCHours(0, 0, 0, 0);
            return Math.floor((t - new Date(0)) / 864e5);
        }

        function parseCSV(csv, expiry) {
            const longs = [], shorts = [];
            for (const line of csv.trim().split('\n')) {
                const p = line.split(',');
                if (p.length < 7) continue;
                try {
                    if (parseInt(p[1]) !== expiry) continue;
                    const pos = { type: p[0] === '0' ? 'call' : 'put', strike: +p[2], size: +p[5], premium: +p[6] };
                    if (p[4] === '0') longs.push(pos); else shorts.push(pos);
                } catch { }
            }
            return { longs, shorts };
        }

        function calcPnL(positions, price, isBuyer) {
            let total = 0;
            for (const p of positions) {
                const intrinsic = p.type === 'call' ? Math.max(price - p.strike, 0) : Math.max(p.strike - price, 0);
                total += (isBuyer ? intrinsic - p.premium : p.premium - intrinsic) * p.size;
            }
            return total;
        }

        function findLevels(longs, shorts) {
            const strikes = [...longs, ...shorts].map(p => p.strike);
            if (!strikes.length) return { r: 95000, s: 85000 };

            const min = Math.floor(Math.min(...strikes) * 0.9);
            const max = Math.ceil(Math.max(...strikes) * 1.1);
            const crosses = [];
            let prevDiff = null;

            for (let price = min; price < max; price += 10) {
                const diff = calcPnL(longs, price, true) - calcPnL(shorts, price, false);
                if (prevDiff !== null && prevDiff * diff < 0) crosses.push(price);
                prevDiff = diff;
            }

            if (crosses.length >= 2) return { s: crosses[0], r: crosses[crosses.length - 1] };
            if (crosses.length === 1) return { s: crosses[0], r: crosses[0] };
            const avg = strikes.reduce((a, b) => a + b, 0) / strikes.length;
            return { s: Math.round(avg * 0.95), r: Math.round(avg * 1.05) };
        }

        async function calculate() {
            document.getElementById('status').textContent = 'Calculating...';
            try {
                const now = new Date();
                const start = new Date(now); start.setUTCHours(0, 0, 0, 0);
                const url = `${PROXY}${API}?source=1&fromDate=${start.getTime()}&toDate=${now.getTime()}`;
                const res = await fetch(url);
                const csv = await res.text();

                const { longs, shorts } = parseCSV(csv, getTomorrowExpiry());
                document.getElementById('stat-longs').textContent = longs.length;
                document.getElementById('stat-shorts').textContent = shorts.length;

                if (!longs.length || !shorts.length) { document.getElementById('status').textContent = 'No data'; return; }

                const { r, s } = findLevels(longs, shorts);
                const time = Math.floor(now.getTime() / 1000);

                // ADD POINT
                points.push({ time, r, s });

                console.log(`âœ… ${now.toLocaleTimeString()} R=${r} S=${s}`);

                rebuildLines();
                updateUI(r, s);
                updateHistory();

                document.getElementById('stat-points').textContent = points.length;
                document.getElementById('status').textContent = 'Live';
            } catch (e) {
                console.error(e);
                document.getElementById('status').textContent = 'Error';
            }
            nextUpdate = Date.now() + INTERVAL;
        }

        function rebuildLines() {
            if (!points.length || !candles.length) return;

            // Build R/S line data - connects all points with diagonal lines (like Pine Script)
            const rData = points.map(p => ({ time: p.time, value: p.r }));
            const sData = points.map(p => ({ time: p.time, value: p.s }));

            rSeries.setData(rData);
            sSeries.setData(sData);
        }

        function initChart() {
            const container = document.getElementById('chart');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' },
                grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } },
                rightPriceScale: { borderColor: '#363a45' },
                timeScale: { borderColor: '#363a45', timeVisible: true },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a', downColor: '#ef5350',
                borderUpColor: '#26a69a', borderDownColor: '#ef5350',
                wickUpColor: '#26a69a', wickDownColor: '#ef5350',
            });

            // CONNECTING LINES - like your Pine Script
            rSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 3, title: 'R', priceLineVisible: true });
            sSeries = chart.addLineSeries({ color: '#9c27b0', lineWidth: 3, title: 'S', priceLineVisible: true });

            new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight })).observe(container);
        }

        async function fetchCandles() {
            const interval = tf + 'm';
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=500`);
            const data = await res.json();

            candles = data.map(d => ({
                time: d[0] / 1000,
                open: +d[1], high: +d[2], low: +d[3], close: +d[4],
            }));

            candleSeries.setData(candles);
            chart.timeScale().fitContent();
            rebuildLines();
        }

        function connectWS() {
            if (ws) ws.close();
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${tf}m`);
            ws.onmessage = (e) => {
                const { k } = JSON.parse(e.data);
                candleSeries.update({ time: k.t / 1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c });

                // Extend lines to current candle
                if (points.length) {
                    const last = points[points.length - 1];
                    rSeries.update({ time: k.t / 1000, value: last.r });
                    sSeries.update({ time: k.t / 1000, value: last.s });
                }

                document.getElementById('price').textContent = '$' + (+k.c).toLocaleString('en-US', { maximumFractionDigits: 0 });
            };
        }

        function updateUI(r, s) {
            document.getElementById('r-val').textContent = '$' + r.toLocaleString();
            document.getElementById('s-val').textContent = '$' + s.toLocaleString();
            document.getElementById('range-val').textContent = '$' + (r - s).toLocaleString();
        }

        function updateHistory() {
            const h = document.getElementById('history');
            h.innerHTML = [...points].reverse().slice(0, 15).map(p => {
                const time = new Date(p.time * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                return `<div class="history-item">${time} â†’ R:$${(p.r / 1000).toFixed(1)}K S:$${(p.s / 1000).toFixed(1)}K</div>`;
            }).join('');
        }

        setInterval(() => {
            if (nextUpdate) {
                const secs = Math.max(0, Math.floor((nextUpdate - Date.now()) / 1000));
                document.getElementById('stat-next').textContent = `${Math.floor(secs / 60)}:${(secs % 60).toString().padStart(2, '0')}`;
            }
        }, 1000);

        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                tf = btn.dataset.tf;
                fetchCandles().then(connectWS);
            });
        });

        document.getElementById('btn-calc').addEventListener('click', calculate);

        initChart();
        fetchCandles().then(() => { connectWS(); calculate(); });
        setInterval(calculate, INTERVAL);
    </script>
</body>

</html>