<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Levels Tracker - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e222d;
            border-bottom: 1px solid #363a45;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .logo {
            font-weight: 600;
            font-size: 15px;
        }

        .price-box {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
        }

        .change {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .change.up {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
        }

        .change.down {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #787b86;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #26a69a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #1e222d;
            padding: 6px 12px;
            display: flex;
            gap: 4px;
            border-bottom: 1px solid #363a45;
        }

        .toolbar button {
            padding: 5px 12px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #d1d4dc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .toolbar button:hover {
            background: #363a45;
        }

        .toolbar button.active {
            background: #2962ff;
            border-color: #2962ff;
        }

        #chart {
            flex: 1;
        }

        .sidebar {
            width: 280px;
            background: #1e222d;
            border-left: 1px solid #363a45;
            overflow-y: auto;
            font-size: 12px;
        }

        .panel {
            border-bottom: 1px solid #363a45;
            padding: 12px;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        .level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #2a2e39;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .level-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot.r {
            background: #00ff00;
        }

        .dot.s {
            background: #ff0000;
        }

        .dot.bg {
            background: #00bcd4;
        }

        .dot.sg {
            background: #ff9800;
        }

        .dot.c {
            background: #2962ff;
        }

        .level-value {
            font-weight: 600;
            font-family: 'Monaco', monospace;
            font-size: 11px;
        }

        .level-value.r {
            color: #00ff00;
        }

        .level-value.s {
            color: #ff0000;
        }

        .level-value.bg {
            color: #00bcd4;
        }

        .level-value.sg {
            color: #ff9800;
        }

        .level-value.c {
            color: #2962ff;
        }

        .position-bar {
            height: 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin: 10px 0 6px;
            position: relative;
        }

        .position-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ffd600, #00ff00);
            border-radius: 3px;
        }

        .position-marker {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 10px;
            background: #2962ff;
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .position-text {
            text-align: center;
            font-size: 11px;
            color: #787b86;
        }

        .position-pct {
            color: #d1d4dc;
            font-weight: 600;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #2a2e39;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #787b86;
        }

        .stats-value {
            font-weight: 500;
        }

        .stats-value.green {
            color: #4caf50;
        }

        .stats-value.red {
            color: #f44336;
        }

        .stats-value.yellow {
            color: #ffeb3b;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .toggle-switch {
            position: relative;
            width: 32px;
            height: 18px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #2a2e39;
            border-radius: 18px;
            transition: 0.2s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background: #787b86;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: #2962ff;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(14px);
            background: white;
        }

        .history-list {
            max-height: 120px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            background: #2a2e39;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 10px;
        }

        .history-time {
            color: #787b86;
        }

        .history-r {
            color: #00ff00;
        }

        .history-s {
            color: #ff0000;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">üìä Options Levels Tracker (Dynamic)</div>
        <div class="price-box">
            <span class="price" id="price">$---,---</span>
            <span class="change up" id="change">+0.00%</span>
        </div>
        <div class="status">
            <span class="status-dot"></span>
            <span id="status">Connecting...</span>
        </div>
    </header>

    <div class="main">
        <div class="chart-area">
            <div class="toolbar">
                <button data-tf="1">1m</button>
                <button data-tf="5">5m</button>
                <button data-tf="15" class="active">15m</button>
                <button data-tf="60">1H</button>
                <button data-tf="240">4H</button>
                <button data-tf="D">1D</button>
            </div>
            <div id="chart"></div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">üìä Current Levels</div>

                <div class="level">
                    <div class="level-label">
                        <div class="dot r"></div> Resistance
                    </div>
                    <span class="level-value r" id="r-val">$---</span>
                </div>

                <div class="level">
                    <div class="level-label">
                        <div class="dot bg"></div> Buyer Gamma
                    </div>
                    <span class="level-value bg" id="bg-val">$---</span>
                </div>

                <div class="level">
                    <div class="level-label">
                        <div class="dot c"></div> Current Price
                    </div>
                    <span class="level-value c" id="c-val">$---</span>
                </div>

                <div class="level">
                    <div class="level-label">
                        <div class="dot sg"></div> Seller Gamma
                    </div>
                    <span class="level-value sg" id="sg-val">$---</span>
                </div>

                <div class="level">
                    <div class="level-label">
                        <div class="dot s"></div> Support
                    </div>
                    <span class="level-value s" id="s-val">$---</span>
                </div>

                <div class="position-bar">
                    <div class="position-fill"></div>
                    <div class="position-marker" id="marker" style="left:50%"></div>
                </div>
                <div class="position-text"><span class="position-pct" id="pct">--</span>% in range</div>
            </div>

            <div class="panel">
                <div class="panel-title">‚öôÔ∏è Display</div>
                <div class="toggle-row"><span>Resistance</span><label class="toggle-switch"><input type="checkbox"
                            id="show-r" checked><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><span>Support</span><label class="toggle-switch"><input type="checkbox"
                            id="show-s" checked><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><span>Buyer Gamma</span><label class="toggle-switch"><input type="checkbox"
                            id="show-bg" checked><span class="toggle-slider"></span></label></div>
                <div class="toggle-row"><span>Seller Gamma</span><label class="toggle-switch"><input type="checkbox"
                            id="show-sg" checked><span class="toggle-slider"></span></label></div>
            </div>

            <div class="panel">
                <div class="panel-title">üìà Statistics</div>
                <div class="stats-row"><span class="stats-label">Range</span><span class="stats-value yellow"
                        id="stat-range">$---</span></div>
                <div class="stats-row"><span class="stats-label">Dist to R</span><span class="stats-value green"
                        id="stat-dist-r">--%</span></div>
                <div class="stats-row"><span class="stats-label">Dist to S</span><span class="stats-value red"
                        id="stat-dist-s">--%</span></div>
                <div class="stats-row"><span class="stats-label">Position</span><span class="stats-value yellow"
                        id="stat-pos">--</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">üîÑ Level History</div>
                <div class="history-list" id="history-list">
                    <div class="history-item"><span class="history-time">Monitoring...</span></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        let chart, candleSeries;
        let rSeries, sSeries, bgSeries, sgSeries; // Dynamic line series (like MAs)
        let currentLevels = { r: 0, s: 0, bg: 0, sg: 0 };
        let currentPrice = 0;
        let timeframe = '15';
        let ws = null;
        let intradayHistory = [];
        
        // Store historical level data for dynamic lines
        let levelHistory = {
            r: [],   // [{time, value}]
            s: [],
            bg: [],
            sg: []
        };
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CHART INITIALIZATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function initChart() {
            const container = document.getElementById('chart');
            
            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { type: 'solid', color: '#131722' },
                    textColor: '#d1d4dc',
                },
                grid: {
                    vertLines: { color: '#1e222d' },
                    horzLines: { color: '#1e222d' },
                },
                rightPriceScale: { borderColor: '#363a45' },
                timeScale: { 
                    borderColor: '#363a45',
                    timeVisible: true,
                },
                crosshair: { mode: 1 },
            });
            
            // Candlestick series
            candleSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderUpColor: '#26a69a',
                borderDownColor: '#ef5350',
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });
            
            // Dynamic line series (like moving averages)
            rSeries = chart.addLineSeries({
                color: '#00ff00',
                lineWidth: 2,
                title: 'R',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            sSeries = chart.addLineSeries({
                color: '#ff0000',
                lineWidth: 2,
                title: 'S',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            bgSeries = chart.addLineSeries({
                color: '#00bcd4',
                lineWidth: 1,
                lineStyle: 2, // Dashed
                title: 'BG',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            sgSeries = chart.addLineSeries({
                color: '#ff9800',
                lineWidth: 1,
                lineStyle: 2,
                title: 'SG',
                priceLineVisible: true,
                lastValueVisible: true,
            });
            
            new ResizeObserver(() => {
                chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
            }).observe(container);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UPDATE DYNAMIC LINE SERIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateLineSeries() {
            // Show/hide based on toggles
            const showR = document.getElementById('show-r').checked;
            const showS = document.getElementById('show-s').checked;
            const showBG = document.getElementById('show-bg').checked;
            const showSG = document.getElementById('show-sg').checked;
            
            rSeries.applyOptions({ visible: showR });
            sSeries.applyOptions({ visible: showS });
            bgSeries.applyOptions({ visible: showBG });
            sgSeries.applyOptions({ visible: showSG });
            
            // Update data
            if (levelHistory.r.length > 0) rSeries.setData(levelHistory.r);
            if (levelHistory.s.length > 0) sSeries.setData(levelHistory.s);
            if (levelHistory.bg.length > 0) bgSeries.setData(levelHistory.bg);
            if (levelHistory.sg.length > 0) sgSeries.setData(levelHistory.sg);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FETCH CANDLES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function fetchCandles() {
            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${interval}&limit=500`);
            const data = await res.json();
            
            const candles = data.map(d => ({
                time: d[0] / 1000,
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4]),
            }));
            
            candleSeries.setData(candles);
            
            // Initialize level history with current levels for all candles
            // This creates a "step" pattern until we get real historical data
            if (currentLevels.r > 0) {
                initializeLevelHistory(candles);
            }
            
            chart.timeScale().fitContent();
        }
        
        function initializeLevelHistory(candles) {
            // For now, fill with current levels (will become dynamic as we fetch new data)
            const lastCandles = candles.slice(-100); // Use last 100 candles
            
            levelHistory.r = lastCandles.map(c => ({ time: c.time, value: currentLevels.r }));
            levelHistory.s = lastCandles.map(c => ({ time: c.time, value: currentLevels.s }));
            levelHistory.bg = lastCandles.map(c => ({ time: c.time, value: currentLevels.bg }));
            levelHistory.sg = lastCandles.map(c => ({ time: c.time, value: currentLevels.sg }));
            
            updateLineSeries();
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // WEBSOCKET FOR LIVE CANDLES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function connectWS() {
            if (ws) ws.close();
            
            const interval = timeframe === 'D' ? '1d' : timeframe + 'm';
            ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${interval}`);
            
            ws.onmessage = (e) => {
                const { k } = JSON.parse(e.data);
                currentPrice = parseFloat(k.c);
                const candleTime = k.t / 1000;
                
                candleSeries.update({
                    time: candleTime,
                    open: parseFloat(k.o),
                    high: parseFloat(k.h),
                    low: parseFloat(k.l),
                    close: parseFloat(k.c),
                });
                
                // Update dynamic lines with current candle time
                if (currentLevels.r > 0) {
                    rSeries.update({ time: candleTime, value: currentLevels.r });
                    sSeries.update({ time: candleTime, value: currentLevels.s });
                    bgSeries.update({ time: candleTime, value: currentLevels.bg });
                    sgSeries.update({ time: candleTime, value: currentLevels.sg });
                }
                
                updateUI();
            };
            
            ws.onopen = () => document.getElementById('status').textContent = 'Live';
            ws.onerror = () => document.getElementById('status').textContent = 'Reconnecting...';
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FETCH LEVELS FROM HISTORICAL DATA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function fetchLevels() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/mabkkhome-lgtm/deribit-options-data/main/data/btc_levels.csv?t=' + Date.now());
                const text = await res.text();
                const lines = text.trim().split('\n');
                
                if (lines.length > 1) {
                    // Parse ALL historical data to build dynamic lines
                    levelHistory = { r: [], s: [], bg: [], sg: [] };
                    
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(',');
                        if (parts.length >= 3) {
                            const dateStr = parts[0].trim();
                            const r = parseFloat(parts[1]);
                            const s = parseFloat(parts[2]);
                            const bg = parts.length >= 4 ? parseFloat(parts[3]) : r;
                            const sg = parts.length >= 5 ? parseFloat(parts[4]) : s;
                            
                            // Parse date (dd/mm/yyyy format)
                            const dateParts = dateStr.split('/');
                            if (dateParts.length === 3) {
                                const day = parseInt(dateParts[0]);
                                const month = parseInt(dateParts[1]) - 1;
                                const year = parseInt(dateParts[2]);
                                const timestamp = new Date(year, month, day).getTime() / 1000;
                                
                                levelHistory.r.push({ time: timestamp, value: r });
                                levelHistory.s.push({ time: timestamp, value: s });
                                levelHistory.bg.push({ time: timestamp, value: bg });
                                levelHistory.sg.push({ time: timestamp, value: sg });
                            }
                        }
                    }
                    
                    // Sort by time
                    ['r', 's', 'bg', 'sg'].forEach(key => {
                        levelHistory[key].sort((a, b) => a.time - b.time);
                    });
                    
                    // Get latest values
                    const lastLine = lines[lines.length - 1].split(',');
                    const newR = parseFloat(lastLine[1]);
                    const newS = parseFloat(lastLine[2]);
                    const newBG = lastLine.length >= 4 ? parseFloat(lastLine[3]) : newR;
                    const newSG = lastLine.length >= 5 ? parseFloat(lastLine[4]) : newS;
                    
                    // Track changes
                    if (currentLevels.r > 0 && (newR !== currentLevels.r || newS !== currentLevels.s)) {
                        intradayHistory.unshift({
                            time: new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'}),
                            r: newR,
                            s: newS
                        });
                        if (intradayHistory.length > 20) intradayHistory.pop();
                        updateHistory();
                    }
                    
                    currentLevels = { r: newR, s: newS, bg: newBG, sg: newSG };
                    
                    // Update line series
                    updateLineSeries();
                    updateUI();
                    updateStats();
                }
            } catch (e) {
                console.error('Error fetching levels:', e);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UPDATE UI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateUI() {
            const fmt = (n) => '$' + n.toLocaleString('en-US', {maximumFractionDigits: 0});
            
            document.getElementById('price').textContent = fmt(currentPrice);
            document.getElementById('c-val').textContent = fmt(currentPrice);
            document.getElementById('r-val').textContent = fmt(currentLevels.r);
            document.getElementById('s-val').textContent = fmt(currentLevels.s);
            document.getElementById('bg-val').textContent = fmt(currentLevels.bg);
            document.getElementById('sg-val').textContent = fmt(currentLevels.sg);
            
            if (currentLevels.r > currentLevels.s && currentPrice > 0) {
                const range = currentLevels.r - currentLevels.s;
                const pct = ((currentPrice - currentLevels.s) / range) * 100;
                const clamped = Math.max(0, Math.min(100, pct));
                document.getElementById('marker').style.left = clamped + '%';
                document.getElementById('pct').textContent = pct.toFixed(1);
            }
        }
        
        function updateStats() {
            const r = currentLevels.r;
            const s = currentLevels.s;
            const range = r - s;
            
            document.getElementById('stat-range').textContent = '$' + range.toLocaleString();
            
            if (currentPrice > 0 && r > 0 && s > 0) {
                const distR = ((r - currentPrice) / currentPrice * 100).toFixed(2);
                const distS = ((currentPrice - s) / currentPrice * 100).toFixed(2);
                document.getElementById('stat-dist-r').textContent = distR + '%';
                document.getElementById('stat-dist-s').textContent = distS + '%';
                
                const pct = ((currentPrice - s) / range) * 100;
                let posText = '‚ö™ Mid';
                if (pct > 66) posText = 'üî¥ Near R';
                else if (pct < 33) posText = 'üü¢ Near S';
                document.getElementById('stat-pos').textContent = posText + ' ' + pct.toFixed(1) + '%';
            }
        }
        
        function updateHistory() {
            const container = document.getElementById('history-list');
            if (intradayHistory.length === 0) {
                container.innerHTML = '<div class="history-item"><span class="history-time">No changes yet</span></div>';
                return;
            }
            
            container.innerHTML = intradayHistory.map(h => `
                <div class="history-item">
                    <span class="history-time">${h.time}</span>
                    <span class="history-r">R: ${(h.r/1000).toFixed(1)}K</span>
                    <span class="history-s">S: ${(h.s/1000).toFixed(1)}K</span>
                </div>
            `).join('');
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT LISTENERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        document.querySelectorAll('[data-tf]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-tf]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                timeframe = btn.dataset.tf;
                fetchCandles().then(() => {
                    updateLineSeries();
                    connectWS();
                });
            });
        });
        
        ['show-r', 'show-s', 'show-bg', 'show-sg'].forEach(id => {
            document.getElementById(id).addEventListener('change', updateLineSeries);
        });
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        initChart();
        fetchLevels().then(() => {
            fetchCandles().then(() => {
                connectWS();
            });
        });
        
        // Fetch levels every 30 seconds
        setInterval(fetchLevels, 30000);
    </script>
</body>

</html>