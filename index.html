<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Levels Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #131722;
            color: #d1d4dc;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e222d;
            border-bottom: 1px solid #363a45;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
        }

        .logo {
            font-weight: 600;
            font-size: 15px;
        }

        .price {
            font-size: 22px;
            font-weight: 700;
        }

        .price-change {
            font-size: 12px;
            margin-left: 8px;
        }

        .price-change.up {
            color: #26a69a;
        }

        .price-change.down {
            color: #ef5350;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #787b86;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #26a69a;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.loading {
            background: #ff9800;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #1e222d;
            padding: 6px 12px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #363a45;
            align-items: center;
        }

        .toolbar button {
            padding: 5px 10px;
            background: #2a2e39;
            border: 1px solid #363a45;
            color: #d1d4dc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .toolbar button:hover {
            background: #363a45;
        }

        .toolbar button.active {
            background: #2962ff;
            border-color: #2962ff;
        }

        .toolbar button:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .toolbar .sep {
            width: 1px;
            height: 20px;
            background: #363a45;
        }

        #chart {
            flex: 1;
        }

        /* Indicator Menu - TradingView Style */
        .indicator-menu-wrapper {
            position: relative;
        }

        .indicator-btn {
            background: #2962ff !important;
        }

        .indicator-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e222d;
            border: 1px solid #363a45;
            border-radius: 4px;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .indicator-menu.show {
            display: block;
        }

        .indicator-menu-header {
            padding: 12px;
            border-bottom: 1px solid #363a45;
        }

        .indicator-search {
            width: 100%;
            padding: 8px 12px;
            background: #2a2e39;
            border: 1px solid #363a45;
            border-radius: 4px;
            color: #d1d4dc;
            font-size: 12px;
        }

        .indicator-search:focus {
            outline: none;
            border-color: #2962ff;
        }

        .indicator-category {
            padding: 8px 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            background: #131722;
        }

        .indicator-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid #1e222d;
        }

        .indicator-item:hover {
            background: #2a2e39;
        }

        .indicator-item.active {
            background: #2a2e39;
        }

        .indicator-item .name {
            font-size: 12px;
        }

        .indicator-item .desc {
            font-size: 10px;
            color: #787b86;
        }

        .indicator-item .check {
            width: 18px;
            height: 18px;
            border: 2px solid #363a45;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
        }

        .indicator-item.active .check {
            background: #2962ff;
            border-color: #2962ff;
            color: white;
        }

        .indicator-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }

        /* Active Indicators Bar */
        .active-indicators {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .active-ind-tag {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: #2a2e39;
            border-radius: 4px;
            font-size: 10px;
        }

        .active-ind-tag .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .active-ind-tag .remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 12px;
        }

        .active-ind-tag .remove:hover {
            opacity: 1;
        }

        .sidebar {
            width: 320px;
            background: #1e222d;
            border-left: 1px solid #363a45;
            overflow-y: auto;
            font-size: 12px;
        }

        .panel {
            border-bottom: 1px solid #363a45;
            padding: 12px;
        }

        .panel-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: #787b86;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-badge {
            background: #2962ff;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
        }

        .level {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            background: #2a2e39;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .level-value {
            font-weight: 600;
            font-family: 'Monaco', monospace;
            font-size: 11px;
        }

        .level-value.r {
            color: #2196f3;
        }

        .level-value.s {
            color: #9c27b0;
        }

        .level-value.bg {
            color: #00bcd4;
        }

        .level-value.sg {
            color: #ff9800;
        }

        .level-value.vwap {
            color: #ffeb3b;
        }

        .level-value.green {
            color: #4caf50;
        }

        .level-value.red {
            color: #f44336;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #2a2e39;
            font-size: 11px;
        }

        .stats-label {
            color: #787b86;
        }

        .stats-value.green {
            color: #4caf50;
        }

        .stats-value.red {
            color: #f44336;
        }

        .stats-value.cyan {
            color: #00bcd4;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .toggle {
            position: relative;
            width: 36px;
            height: 20px;
            background: #363a45;
            border-radius: 10px;
            cursor: pointer;
        }

        .toggle.on {
            background: #2962ff;
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        .toggle.on::after {
            left: 18px;
        }

        .position-bar {
            height: 8px;
            background: linear-gradient(90deg, #ff9800, #9c27b0, #787b86, #2196f3, #00bcd4);
            border-radius: 4px;
            margin: 8px 0;
            position: relative;
        }

        .position-marker {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 12px;
            background: #fff;
            border-radius: 2px;
            transform: translateX(-50%);
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .option-card {
            background: #2a2e39;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
        }

        .option-card .value {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .option-card .label {
            font-size: 9px;
            color: #787b86;
            text-transform: uppercase;
        }

        .bias-bar {
            height: 6px;
            background: #363a45;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
            display: flex;
        }

        .bias-long {
            background: #4caf50;
            height: 100%;
        }

        .bias-short {
            background: #f44336;
            height: 100%;
        }

        .strike-list {
            max-height: 100px;
            overflow-y: auto;
            font-size: 10px;
        }

        .strike-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 4px;
            border-bottom: 1px solid #1e222d;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">üìä Options Levels Tracker</div>
        <div><span class="price" id="price">$---,---</span><span class="price-change" id="price-change">--</span></div>
        <div class="status"><span class="status-dot" id="status-dot"></span><span id="status">Loading...</span></div>
    </header>

    <div class="main">
        <div class="chart-area">
            <div class="toolbar">
                <!-- Timeframe Buttons -->
                <button data-tf="1m">1m</button>
                <button data-tf="5m">5m</button>
                <button data-tf="15m" class="active">15m</button>
                <button data-tf="1h">1H</button>
                <button data-tf="4h">4H</button>
                <button data-tf="1d">1D</button>
                <div class="sep"></div>

                <!-- Indicators Menu (TradingView Style) -->
                <div class="indicator-menu-wrapper">
                    <button class="indicator-btn" id="indicators-btn">üìà Indicators</button>
                    <div class="indicator-menu" id="indicator-menu">
                        <div class="indicator-menu-header">
                            <input type="text" class="indicator-search" id="indicator-search"
                                placeholder="Search indicators...">
                        </div>
                        <div class="indicator-category">Moving Averages</div>
                        <div class="indicator-item" data-ind="vwap"><span class="indicator-color"
                                style="background:#ffeb3b"></span>
                            <div>
                                <div class="name">VWAP</div>
                                <div class="desc">Volume Weighted Average Price</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="ema9"><span class="indicator-color"
                                style="background:#26a69a"></span>
                            <div>
                                <div class="name">EMA 9</div>
                                <div class="desc">Exponential Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="ema20"><span class="indicator-color"
                                style="background:#42a5f5"></span>
                            <div>
                                <div class="name">EMA 20</div>
                                <div class="desc">Exponential Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="ema50"><span class="indicator-color"
                                style="background:#ab47bc"></span>
                            <div>
                                <div class="name">EMA 50</div>
                                <div class="desc">Exponential Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="sma20"><span class="indicator-color"
                                style="background:#78909c"></span>
                            <div>
                                <div class="name">SMA 20</div>
                                <div class="desc">Simple Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="sma50"><span class="indicator-color"
                                style="background:#607d8b"></span>
                            <div>
                                <div class="name">SMA 50</div>
                                <div class="desc">Simple Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="sma200"><span class="indicator-color"
                                style="background:#ff7043"></span>
                            <div>
                                <div class="name">SMA 200</div>
                                <div class="desc">Simple Moving Average</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-category">Volatility</div>
                        <div class="indicator-item" data-ind="bb"><span class="indicator-color"
                                style="background:#787b86"></span>
                            <div>
                                <div class="name">Bollinger Bands</div>
                                <div class="desc">20 period, 2 std dev</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-item" data-ind="kc"><span class="indicator-color"
                                style="background:#26c6da"></span>
                            <div>
                                <div class="name">Keltner Channel</div>
                                <div class="desc">20 period ATR channel</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                        <div class="indicator-category">Trend</div>
                        <div class="indicator-item" data-ind="supertrend"><span class="indicator-color"
                                style="background:#4caf50"></span>
                            <div>
                                <div class="name">Supertrend</div>
                                <div class="desc">ATR based trend indicator</div>
                            </div>
                            <div class="check">‚úì</div>
                        </div>
                    </div>
                </div>

                <!-- Active Indicators Tags -->
                <div class="active-indicators" id="active-indicators"></div>

                <div style="flex:1"></div>
                <button class="btn-refresh" id="btn-refresh">üîÑ Update</button>
            </div>
            <div id="chart"></div>
        </div>

        <aside class="sidebar">
            <div class="panel">
                <div class="panel-title">üìä Options Levels <span class="panel-badge">LIVE</span></div>
                <div class="level"><span>üî∑ Buyer Gamma</span><span class="level-value bg" id="bg-val">---</span></div>
                <div class="level"><span>üîµ Resistance</span><span class="level-value r" id="r-val">---</span></div>
                <div class="level"><span>üü° VWAP</span><span class="level-value vwap" id="vwap-val">---</span></div>
                <div class="level"><span>üü£ Support</span><span class="level-value s" id="s-val">---</span></div>
                <div class="level"><span>üü† Seller Gamma</span><span class="level-value sg" id="sg-val">---</span></div>
                <div class="position-bar">
                    <div class="position-marker" id="pos-marker" style="left:50%"></div>
                </div>
                <div class="level"><span>üìç Position</span><span class="level-value" id="pos-val">--%</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">üìà Options Flow</div>
                <div class="options-grid">
                    <div class="option-card">
                        <div class="value green" id="stat-longs">--</div>
                        <div class="label">Longs</div>
                    </div>
                    <div class="option-card">
                        <div class="value red" id="stat-shorts">--</div>
                        <div class="label">Shorts</div>
                    </div>
                    <div class="option-card">
                        <div class="value" id="stat-calls">--</div>
                        <div class="label">Calls</div>
                    </div>
                    <div class="option-card">
                        <div class="value" id="stat-puts">--</div>
                        <div class="label">Puts</div>
                    </div>
                </div>
                <div class="bias-bar">
                    <div class="bias-long" id="bias-long" style="width:50%"></div>
                    <div class="bias-short" style="width:50%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:9px;color:#787b86;margin-top:2px;">
                    <span>Bulls</span><span id="bias-pct">50%</span><span>Bears</span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-title">üéØ Top Strikes</div>
                <div class="strike-list" id="strike-list">Loading...</div>
            </div>

            <div class="panel">
                <div class="panel-title">üìä Stats</div>
                <div class="stats-row"><span class="stats-label">Total Premium</span><span id="stat-premium">$--</span>
                </div>
                <div class="stats-row"><span class="stats-label">Avg Strike</span><span id="stat-avgstrike">$--</span>
                </div>
                <div class="stats-row"><span class="stats-label">Historical Days</span><span id="stat-days">--</span>
                </div>
                <div class="stats-row"><span class="stats-label">Last Calc</span><span id="stat-time">--:--</span></div>
                <div class="stats-row"><span class="stats-label">Next Update</span><span class="stats-value cyan"
                        id="stat-next">--:--</span></div>
            </div>

            <div class="panel">
                <div class="panel-title">‚öôÔ∏è Levels Display</div>
                <div class="toggle-row"><span>üî∑ Buyer Gamma</span>
                    <div class="toggle on" data-line="bg"></div>
                </div>
                <div class="toggle-row"><span>üîµ Resistance</span>
                    <div class="toggle on" data-line="r"></div>
                </div>
                <div class="toggle-row"><span>üü£ Support</span>
                    <div class="toggle on" data-line="s"></div>
                </div>
                <div class="toggle-row"><span>üü† Seller Gamma</span>
                    <div class="toggle on" data-line="sg"></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const CSV_URL = 'https://raw.githubusercontent.com/mabkkhome-lgtm/deribit-options-data/main/data/btc_levels.csv';
        const THALES_API = 'https://oss.thales-mfi.com/api/MarketScreener/FetchOptions';
        const PROXY = 'https://corsproxy.io/?';
        const UPDATE_INTERVAL = 60000;

        let chart, candleSeries, rSeries, sSeries, bgSeries, sgSeries;
        let indicatorSeries = {};
        let tf = '15m';
        let ws = null;
        let nextUpdate = null;
        let historicalLevels = [];
        let candleData = [];
        let showLines = { r: true, s: true, bg: true, sg: true };
        let activeIndicators = {};
        let currentPrice = 0, openPrice = 0;
        let thalesData = { longs: [], shorts: [], calls: 0, puts: 0, totalPremium: 0, topStrikes: [] };

        // Indicator definitions
        const INDICATORS = {
            vwap: { name: 'VWAP', color: '#ffeb3b', calc: calcVWAP },
            ema9: { name: 'EMA 9', color: '#26a69a', calc: (c) => calcEMA(c, 9) },
            ema20: { name: 'EMA 20', color: '#42a5f5', calc: (c) => calcEMA(c, 20) },
            ema50: { name: 'EMA 50', color: '#ab47bc', calc: (c) => calcEMA(c, 50) },
            sma20: { name: 'SMA 20', color: '#78909c', calc: (c) => calcSMA(c, 20) },
            sma50: { name: 'SMA 50', color: '#607d8b', calc: (c) => calcSMA(c, 50) },
            sma200: { name: 'SMA 200', color: '#ff7043', calc: (c) => calcSMA(c, 200) },
            bb: { name: 'BB', color: '#787b86', calc: calcBB, isBand: true },
            kc: { name: 'KC', color: '#26c6da', calc: calcKC, isBand: true },
            supertrend: { name: 'Supertrend', color: '#4caf50', calc: calcSupertrend }
        };

        function calcVWAP(candles) { let cvp = 0, cv = 0; return candles.map(c => { const tp = (c.high + c.low + c.close) / 3; cvp += tp * (c.volume || 1); cv += (c.volume || 1); return { time: c.time, value: cvp / cv }; }); }
        function calcEMA(candles, p) { const k = 2 / (p + 1); let ema = candles[0]?.close || 0; return candles.map(c => { ema = c.close * k + ema * (1 - k); return { time: c.time, value: ema }; }); }
        function calcSMA(candles, p) { return candles.map((c, i) => { if (i < p - 1) return null; const slice = candles.slice(i - p + 1, i + 1); return { time: c.time, value: slice.reduce((a, b) => a + b.close, 0) / p }; }).filter(Boolean); }
        function calcBB(candles, p = 20, m = 2) { const u = [], l = []; for (let i = p - 1; i < candles.length; i++) { const s = candles.slice(i - p + 1, i + 1).map(c => c.close); const a = s.reduce((x, y) => x + y, 0) / p; const std = Math.sqrt(s.reduce((x, y) => x + (y - a) ** 2, 0) / p); u.push({ time: candles[i].time, value: a + m * std }); l.push({ time: candles[i].time, value: a - m * std }); } return { upper: u, lower: l }; }
        function calcKC(candles, p = 20, m = 1.5) { const u = [], l = []; for (let i = p - 1; i < candles.length; i++) { const s = candles.slice(i - p + 1, i + 1); const ema = s.reduce((a, c) => a + c.close, 0) / p; const atr = s.reduce((a, c) => a + Math.max(c.high - c.low, Math.abs(c.high - (s[s.indexOf(c) - 1]?.close || c.close)), Math.abs(c.low - (s[s.indexOf(c) - 1]?.close || c.close))), 0) / p; u.push({ time: candles[i].time, value: ema + m * atr }); l.push({ time: candles[i].time, value: ema - m * atr }); } return { upper: u, lower: l }; }
        function calcSupertrend(candles, p = 10, m = 3) { const res = []; for (let i = p - 1; i < candles.length; i++) { const s = candles.slice(i - p + 1, i + 1); const atr = s.reduce((a, c) => a + (c.high - c.low), 0) / p; const hl2 = (candles[i].high + candles[i].low) / 2; const up = hl2 - m * atr, dn = hl2 + m * atr; res.push({ time: candles[i].time, value: candles[i].close > dn ? up : dn }); } return res; }

        function getTomorrowExpiry() { const t = new Date(); t.setDate(t.getDate() + 1); t.setUTCHours(0, 0, 0, 0); return Math.floor((t - new Date(0)) / 864e5); }
        function parseThalesCSV(csv, expiry) { const longs = [], shorts = []; let calls = 0, puts = 0, totalPremium = 0; const sm = {}; for (const ln of csv.trim().split('\n')) { const p = ln.split(','); if (p.length < 7) continue; try { if (parseInt(p[1]) !== expiry) continue; const t = p[0] === '0' ? 'call' : 'put', strike = +p[2], size = +p[5], prem = +p[6]; if (p[4] === '0') longs.push({ type: t, strike, size, premium: prem }); else shorts.push({ type: t, strike, size, premium: prem }); if (t === 'call') calls++; else puts++; totalPremium += prem * size; sm[strike] = (sm[strike] || 0) + size; } catch { } } const ts = Object.entries(sm).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([s, z]) => ({ strike: +s, size: z })); return { longs, shorts, calls, puts, totalPremium, topStrikes: ts }; }
        function calcPnL(pos, price, buyer) { let t = 0; for (const p of pos) { const intr = p.type === 'call' ? Math.max(price - p.strike, 0) : Math.max(p.strike - price, 0); t += (buyer ? intr - p.premium : p.premium - intr) * p.size; } return t; }

        function findLevels(longs, shorts) {
            const allPos = [...longs, ...shorts];
            if (!allPos.length) return null;

            // Calculate OI by strike for calls and puts
            const callOI = {}, putOI = {};
            for (const p of allPos) {
                if (p.type === 'call') {
                    callOI[p.strike] = (callOI[p.strike] || 0) + p.size;
                } else {
                    putOI[p.strike] = (putOI[p.strike] || 0) + p.size;
                }
            }

            // R = Strike with highest CALL open interest (resistance)
            let r = 0, maxCallOI = 0;
            for (const [strike, oi] of Object.entries(callOI)) {
                if (oi > maxCallOI) { maxCallOI = oi; r = +strike; }
            }

            // S = Strike with highest PUT open interest (support)
            let s = 0, maxPutOI = 0;
            for (const [strike, oi] of Object.entries(putOI)) {
                if (oi > maxPutOI) { maxPutOI = oi; s = +strike; }
            }

            // Ensure R > S
            if (r < s) [r, s] = [s, r];

            // ==== GAMMA CALCULATION ====
            // Gamma is highest at ATM strikes. We calculate net gamma exposure at each price level.
            // For options: Gamma = OI √ó (gamma factor based on distance to ATM)
            // Buyers (longs) have POSITIVE gamma, Sellers (shorts) have NEGATIVE gamma

            // Calculate net gamma at each strike
            const gammaByStrike = {};
            const allStrikes = [...new Set([...longs, ...shorts].map(p => p.strike))].sort((a, b) => a - b);

            for (const strike of allStrikes) {
                let buyerGamma = 0, sellerGamma = 0;

                for (const p of longs) {
                    if (p.strike === strike) {
                        buyerGamma += p.size; // Buyers have positive gamma
                    }
                }
                for (const p of shorts) {
                    if (p.strike === strike) {
                        sellerGamma += p.size; // Sellers have negative gamma (we track magnitude)
                    }
                }

                gammaByStrike[strike] = { buyer: buyerGamma, seller: sellerGamma, net: buyerGamma - sellerGamma };
            }

            // BG = Upper boundary of gamma band (where cumulative buyer gamma is highest)
            // SG = Lower boundary of gamma band (where cumulative seller gamma is highest)

            // Weight strikes by gamma exposure, find weighted average for buyers (upper band) and sellers (lower band)
            let totalBuyerGamma = 0, buyerWeightedSum = 0;
            let totalSellerGamma = 0, sellerWeightedSum = 0;

            for (const [strike, gamma] of Object.entries(gammaByStrike)) {
                const strikeNum = +strike;
                if (gamma.buyer > 0) {
                    totalBuyerGamma += gamma.buyer;
                    buyerWeightedSum += strikeNum * gamma.buyer;
                }
                if (gamma.seller > 0) {
                    totalSellerGamma += gamma.seller;
                    sellerWeightedSum += strikeNum * gamma.seller;
                }
            }

            // BG = Weighted average of buyer gamma (should be higher)
            // SG = Weighted average of seller gamma (should be lower)
            let bg = totalBuyerGamma > 0 ? Math.round(buyerWeightedSum / totalBuyerGamma) : r;
            let sg = totalSellerGamma > 0 ? Math.round(sellerWeightedSum / totalSellerGamma) : s;

            // Ensure BG > SG (buyer gamma band is upper, seller is lower)
            if (bg < sg) [bg, sg] = [sg, bg];

            // Gamma should be INSIDE R/S range
            if (bg > r) bg = r;
            if (sg < s) sg = s;

            console.log(`üéØ Levels: R=${r}, S=${s}`);
            console.log(`üìä Gamma: BG=${bg} (buyer avg), SG=${sg} (seller avg)`);
            console.log(`   Buyer gamma total: ${totalBuyerGamma.toFixed(2)}, Seller gamma total: ${totalSellerGamma.toFixed(2)}`);

            return { r, s, bg, sg };
        }


        async function calculateLive() { setStatus('Calculating...', true); try { const now = new Date(), start = new Date(now); start.setUTCHours(0, 0, 0, 0); const res = await fetch(`${PROXY}${THALES_API}?source=1&fromDate=${start.getTime()}&toDate=${now.getTime()}`); thalesData = parseThalesCSV(await res.text(), getTomorrowExpiry()); updateThalesUI(); if (thalesData.longs.length && thalesData.shorts.length) { const lv = findLevels(thalesData.longs, thalesData.shorts); if (lv) { const td = Math.floor(new Date().setUTCHours(0, 0, 0, 0) / 1000); const ex = historicalLevels.find(h => h.timestamp >= td); if (ex) Object.assign(ex, lv); else { historicalLevels.push({ timestamp: td, ...lv }); historicalLevels.sort((a, b) => a.timestamp - b.timestamp); } updateLevelDisplay(lv); document.getElementById('stat-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }); rebuildLines(); } } setStatus('Live', false); } catch (e) { console.error(e); setStatus('Error', false); } nextUpdate = Date.now() + UPDATE_INTERVAL; }
        function updateThalesUI() { document.getElementById('stat-longs').textContent = thalesData.longs.length; document.getElementById('stat-shorts').textContent = thalesData.shorts.length; document.getElementById('stat-calls').textContent = thalesData.calls; document.getElementById('stat-puts').textContent = thalesData.puts; document.getElementById('stat-premium').textContent = '$' + (thalesData.totalPremium / 1000).toFixed(1) + 'K'; const all = [...thalesData.longs, ...thalesData.shorts].map(p => p.strike); document.getElementById('stat-avgstrike').textContent = '$' + (all.length ? (all.reduce((a, b) => a + b, 0) / all.length).toLocaleString(undefined, { maximumFractionDigits: 0 }) : '--'); const lp = thalesData.longs.length / (thalesData.longs.length + thalesData.shorts.length || 1) * 100; document.getElementById('bias-long').style.width = lp + '%'; document.getElementById('bias-pct').textContent = Math.round(lp) + '% Long'; document.getElementById('strike-list').innerHTML = thalesData.topStrikes.map(s => `<div class="strike-item"><span>$${s.strike.toLocaleString()}</span><span>${s.size.toFixed(2)}</span></div>`).join(''); }
        function updateLevelDisplay(lv) { document.getElementById('r-val').textContent = '$' + lv.r.toLocaleString(); document.getElementById('s-val').textContent = '$' + lv.s.toLocaleString(); document.getElementById('bg-val').textContent = '$' + lv.bg.toLocaleString(); document.getElementById('sg-val').textContent = '$' + lv.sg.toLocaleString(); if (currentPrice > 0) { const pos = ((currentPrice - lv.sg) / (lv.bg - lv.sg) * 100); document.getElementById('pos-marker').style.left = Math.max(0, Math.min(100, pos)) + '%'; document.getElementById('pos-val').textContent = pos.toFixed(1) + '%'; } }
        function parseDate(ds) { const [d, m, y] = ds.split('/').map(Number); return new Date(y, m - 1, d).getTime() / 1000; }
        async function loadHistoricalLevels() { try { const res = await fetch(CSV_URL + '?t=' + Date.now()); const txt = await res.text(); historicalLevels = []; for (const ln of txt.trim().split('\n').slice(1)) { const p = ln.split(','); if (p.length >= 3) { const ts = parseDate(p[0].trim()), r = +p[1], s = +p[2], rng = r - s; if (!isNaN(ts) && !isNaN(r) && !isNaN(s)) historicalLevels.push({ timestamp: ts, r, s, bg: r + rng * 0.3, sg: s - rng * 0.3 }); } } historicalLevels.sort((a, b) => a.timestamp - b.timestamp); document.getElementById('stat-days').textContent = historicalLevels.length; rebuildLines(); } catch (e) { console.error(e); } }
        function interpolateLevel(ts) { if (!historicalLevels.length) return null; let bf = null, af = null; for (const h of historicalLevels) { if (h.timestamp <= ts) bf = h; if (h.timestamp > ts && !af) af = h; } if (!af) return bf; if (!bf) return af; const r = (ts - bf.timestamp) / (af.timestamp - bf.timestamp); return { r: bf.r + (af.r - bf.r) * r, s: bf.s + (af.s - bf.s) * r, bg: bf.bg + (af.bg - bf.bg) * r, sg: bf.sg + (af.sg - bf.sg) * r }; }
        function rebuildLines() { if (!historicalLevels.length || !candleData.length) return; const rd = [], sd = [], bgd = [], sgd = []; for (const c of candleData) { const lv = interpolateLevel(c.time); if (lv) { rd.push({ time: c.time, value: lv.r }); sd.push({ time: c.time, value: lv.s }); bgd.push({ time: c.time, value: lv.bg }); sgd.push({ time: c.time, value: lv.sg }); } } rSeries.setData(showLines.r ? rd : []); sSeries.setData(showLines.s ? sd : []); bgSeries.setData(showLines.bg ? bgd : []); sgSeries.setData(showLines.sg ? sgd : []); rebuildIndicators(); }

        function rebuildIndicators() {
            if (!candleData.length) return;
            for (const [id, ind] of Object.entries(INDICATORS)) {
                if (activeIndicators[id]) {
                    if (ind.isBand) {
                        const data = ind.calc(candleData);
                        indicatorSeries[id + '_upper']?.setData(data.upper);
                        indicatorSeries[id + '_lower']?.setData(data.lower);
                    } else {
                        const data = ind.calc(candleData);
                        indicatorSeries[id]?.setData(data);
                        if (id === 'vwap' && data.length) document.getElementById('vwap-val').textContent = '$' + data[data.length - 1].value.toLocaleString(undefined, { maximumFractionDigits: 0 });
                    }
                } else {
                    if (ind.isBand) { indicatorSeries[id + '_upper']?.setData([]); indicatorSeries[id + '_lower']?.setData([]); }
                    else indicatorSeries[id]?.setData([]);
                }
            }
        }

        function updateActiveIndicatorTags() {
            const container = document.getElementById('active-indicators');
            container.innerHTML = Object.entries(activeIndicators).filter(([k, v]) => v).map(([id]) => {
                const ind = INDICATORS[id];
                return `<div class="active-ind-tag"><span class="dot" style="background:${ind.color}"></span>${ind.name}<span class="remove" data-ind="${id}">√ó</span></div>`;
            }).join('');
            container.querySelectorAll('.remove').forEach(el => el.addEventListener('click', (e) => { toggleIndicator(e.target.dataset.ind); e.stopPropagation(); }));
        }

        function toggleIndicator(id) {
            activeIndicators[id] = !activeIndicators[id];
            document.querySelector(`.indicator-item[data-ind="${id}"]`)?.classList.toggle('active', activeIndicators[id]);
            updateActiveIndicatorTags();
            rebuildIndicators();
        }

        function initChart() {
            const container = document.getElementById('chart');
            chart = LightweightCharts.createChart(container, { layout: { background: { type: 'solid', color: '#131722' }, textColor: '#d1d4dc' }, grid: { vertLines: { color: '#1e222d' }, horzLines: { color: '#1e222d' } }, rightPriceScale: { borderColor: '#363a45' }, timeScale: { borderColor: '#363a45', timeVisible: true } });
            candleSeries = chart.addCandlestickSeries({ upColor: '#26a69a', downColor: '#ef5350', borderUpColor: '#26a69a', borderDownColor: '#ef5350', wickUpColor: '#26a69a', wickDownColor: '#ef5350' });
            bgSeries = chart.addLineSeries({ color: '#00bcd4', lineWidth: 2, lineStyle: 2 });
            rSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 3 });
            sSeries = chart.addLineSeries({ color: '#9c27b0', lineWidth: 3 });
            sgSeries = chart.addLineSeries({ color: '#ff9800', lineWidth: 2, lineStyle: 2 });

            // Create indicator series
            for (const [id, ind] of Object.entries(INDICATORS)) {
                if (ind.isBand) {
                    indicatorSeries[id + '_upper'] = chart.addLineSeries({ color: ind.color, lineWidth: 1, lineStyle: 2 });
                    indicatorSeries[id + '_lower'] = chart.addLineSeries({ color: ind.color, lineWidth: 1, lineStyle: 2 });
                } else {
                    indicatorSeries[id] = chart.addLineSeries({ color: ind.color, lineWidth: 2 });
                }
            }

            new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth, height: container.clientHeight })).observe(container);
        }

        async function fetchCandles() {
            const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${tf}&limit=500`);
            const d = await res.json();
            candleData = d.map(x => ({ time: x[0] / 1000, open: +x[1], high: +x[2], low: +x[3], close: +x[4], volume: +x[5] }));
            candleSeries.setData(candleData);
            chart.timeScale().fitContent();
            rebuildLines();
            // Fetch 24hr change from ticker
            try { const ticker = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT').then(r => r.json()); openPrice = +ticker.openPrice; updatePriceChange(+ticker.lastPrice); } catch (e) { openPrice = candleData[0]?.open || 0; }
        }
        function updatePriceChange(price) { const chg = ((price - openPrice) / openPrice * 100).toFixed(2); const ce = document.getElementById('price-change'); ce.textContent = (chg >= 0 ? '+' : '') + chg + '%'; ce.className = 'price-change ' + (chg >= 0 ? 'up' : 'down'); }
        function connectWS() { if (ws) ws.close(); if (tf === '1d' || tf === '1w') return; ws = new WebSocket(`wss://stream.binance.com:9443/ws/btcusdt@kline_${tf}`); ws.onmessage = e => { const { k } = JSON.parse(e.data); currentPrice = +k.c; candleSeries.update({ time: k.t / 1000, open: +k.o, high: +k.h, low: +k.l, close: currentPrice }); const lv = interpolateLevel(k.t / 1000); if (lv) { if (showLines.r) rSeries.update({ time: k.t / 1000, value: lv.r }); if (showLines.s) sSeries.update({ time: k.t / 1000, value: lv.s }); if (showLines.bg) bgSeries.update({ time: k.t / 1000, value: lv.bg }); if (showLines.sg) sgSeries.update({ time: k.t / 1000, value: lv.sg }); updateLevelDisplay(lv); } document.getElementById('price').textContent = '$' + currentPrice.toLocaleString('en-US', { maximumFractionDigits: 0 }); updatePriceChange(currentPrice); }; }

        async function switchTimeframe(ntf) { if (ntf === tf) return; document.querySelectorAll('[data-tf]').forEach(b => b.disabled = true); setStatus('Loading...', true); tf = ntf; try { await fetchCandles(); connectWS(); setStatus('Live', false); } catch { setStatus('Error', false); } document.querySelectorAll('[data-tf]').forEach(b => b.disabled = false); }
        function setStatus(t, l) { document.getElementById('status').textContent = t; document.getElementById('status-dot').classList.toggle('loading', l); }

        // Event Listeners
        document.querySelectorAll('[data-tf]').forEach(b => b.addEventListener('click', () => { document.querySelectorAll('[data-tf]').forEach(x => x.classList.remove('active')); b.classList.add('active'); switchTimeframe(b.dataset.tf); }));
        document.getElementById('btn-refresh').addEventListener('click', calculateLive);
        document.querySelectorAll('[data-line]').forEach(t => t.addEventListener('click', function () { this.classList.toggle('on'); showLines[this.dataset.line] = this.classList.contains('on'); rebuildLines(); }));

        // Indicator Menu
        document.getElementById('indicators-btn').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('indicator-menu').classList.toggle('show'); });
        document.addEventListener('click', () => document.getElementById('indicator-menu').classList.remove('show'));
        document.getElementById('indicator-menu').addEventListener('click', e => e.stopPropagation());
        document.querySelectorAll('.indicator-item').forEach(item => item.addEventListener('click', () => toggleIndicator(item.dataset.ind)));
        document.getElementById('indicator-search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('.indicator-item').forEach(item => {
                const name = item.querySelector('.name').textContent.toLowerCase();
                item.style.display = name.includes(q) ? 'flex' : 'none';
            });
        });

        setInterval(() => { if (nextUpdate) { const s = Math.max(0, Math.floor((nextUpdate - Date.now()) / 1000)); document.getElementById('stat-next').textContent = `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`; } }, 1000);

        // Init
        initChart();
        loadHistoricalLevels().then(() => { fetchCandles().then(() => { connectWS(); calculateLive(); }); });
        setInterval(calculateLive, UPDATE_INTERVAL);
    </script>
</body>

</html>